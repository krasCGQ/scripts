#!/usr/bin/env bash
# Copyright (C) 2018 Albert I (krasCGQ)
# SPDX-License-Identifier: GPL-3.0-or-later

function tg_sendinline {
    local COUNT INLINE INLINE_TEXT INLINE_URL REQUEST TEXT

    if [[ ${#} -ge 1 ]]; then
        while [[ ${#} -ge 1 ]]; do
            case ${1} in
                # REQUIRED
                -in|--inline-name)
                    shift

                    INLINE_TEXT="${1}" ;;
                -iu|--inline-url)
                    shift

                    INLINE_URL="${1}" ;;

                # REQUIRED, BUT CAN BE SET EXTERNALLY
                -c |--chat-id)
                    shift

                    TELEGRAM_CHAT=${1} ;;
                -t |--token)
                    shift

                    if [[ ${1} == *:* ]]; then
                        TELEGRAM_TOKEN=${1}
                    else
                        warn "Invalid value specified!"
                        return 1
                    fi ;;

                # EVERYTHING ELSE: Send as part of message instead
                *)
                    TEXT+="${1}\n" ;;
            esac
            shift

            if [[ -n ${INLINE_TEXT} && -n ${INLINE_URL} ]]; then
                [[ -n ${COUNT} ]] && \
                    INLINE+=", "

                [[ -z ${COUNT} ]] && \
                    COUNT=1 || \
                    COUNT=$((COUNT + 1))

                INLINE+="[
                    {
                    \"text\": \"${INLINE_TEXT}\",
                    \"url\": \"${INLINE_URL}\"
                    }
                ]"

                unset INLINE_{TEXT,URL}
            fi
        done
    fi

    [[ -z ${TELEGRAM_TOKEN} || -z ${TELEGRAM_CHAT} ]] && \
        { warn "TELEGRAM_TOKEN or TELEGRAM_CHAT wasn't assigned."; return 1; }

    REQUEST="{
        \"chat_id\": \"${TELEGRAM_CHAT}\",
        \"text\": \"$(echo -e "${TEXT}")\",
        \"reply_markup\": {
            \"inline_keyboard\": [
                ${INLINE}
            ]
        }
    }"

    curl -s -X POST https://api.telegram.org/bot"${TELEGRAM_TOKEN}"/sendMessage \
         -H "Content-Type: application/json" -d "${REQUEST}"
}
