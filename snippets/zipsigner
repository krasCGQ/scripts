# shellcheck shell=bash
# ZipSigner Java wrapper: sign flashable zip with zipsigner
# Copyright (C) 2019-2020 Albert I (krasCGQ)
# SPDX-License-Identifier: GPL-3.0-or-later

zipsigner() {
    local CERT PRIV_KEY SIGNED UNSIGNED

    if [[ -z $(command -v java) ]]; then
        prWarn "Please install any of OpenJDK version before continuing."
        return 1
    elif [[ $# -lt 1 ]]; then
        prWarn "${BLD}Usage:$RST zipsigner [-s signing key] <unsigned-zip> [signed-zip]" \
            "If signed-zip is undefined, it'll default to zip name + signed."
        return 1
    fi

    while [[ $# -ge 1 ]]; do
        case $1 in
        -s | --signing-key)
            shift
            CERT=$1.x509.pem
            PRIV_KEY=$1.pk8
            ;;

        *)
            UNSIGNED=$1
            [[ $# -gt 1 ]] && { shift && SIGNED=$1; } || SIGNED=${UNSIGNED/.zip/-signed.zip}
            ;;
        esac
        shift
    done

    # Create target folder if it doesn't exist
    [[ ! -d $(dirname "$SIGNED") ]] && mkdir -p "$(dirname "$SIGNED")"

    prInfo "Signing $(basename "$UNSIGNED") as $(basename "$SIGNED")..."
    # Make it like this to workaround a weird bug
    java -jar "$SCRIPT_DIR"/prebuilts/bin/zipsigner-3.0-dexed.jar \
        ${CERT:+"$CERT"} ${PRIV_KEY:+"$PRIV_KEY"} "$UNSIGNED" "$SIGNED"
}
