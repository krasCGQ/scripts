# shellcheck shell=bash
# Kernel versioning (branding)
# Copyright (C) 2020 Albert I (krasCGQ)
# SPDX-License-Identifier: GPL-3.0-or-later

# Exit if it's being executed
if ! (return 2>/dev/null); then
    echo "! Please source this script instead of running directly." >&2
    exit 126
fi

# Kernel branding
setBranding() {
    # MoeSyndrome Kernel is only available for the following devices
    if [[ $DEVICE == mido ]]; then
        NAME=MoeSyndrome
        # Define which variant we're building
        if [[ $KERNEL == 4.9 ]]; then
            [[ $(git rev-parse) =~ custom ]] && NAME+=-custom || NAME+=-vanilla
        else
            # Legacy kernel; maintenance support only
            NAME+=-legacy
        fi
    fi
    [[ -n $NAME ]] && return
}

# Generate FKM-compatible JSON
genFkmJson() {
    local BASE_URL CHANGELOG DATE JSON KERNEL_NAME KERNEL_TYPE LINK SHA1 SUPPORT_LINK
    BASE_URL=https://kudnet.id
    # Specific kernel properties
    # VERSION will use one defined from main kernel script generated by `make kernelrelease`
    KERNEL_NAME=$(echo $NAME | cut -d'-' -f1)
    KERNEL_TYPE=$(echo $NAME | cut -d'-' -f2)
    LINK=$BASE_URL/downloads/kernels/$DEVICE/$KERNEL_TYPE/$ZIP
    CHANGELOG=$BASE_URL/ota/kernel/$DEVICE/changelog-$KERNEL_TYPE.md
    DATE=$(date +%Y-%m-%d)
    SHA1=$(sha1sum "$AK/$ZIP" | cut -d' ' -f1)
    # Blank this if no support is going to be provided
    SUPPORT_LINK=https://t.me/joinchat/DX68OlGQPEd7y8VOmc67Eg

    JSON=$(printf '"kernel": { "name": "%s Kernel (%s)", "version": "%s", "link": "%s", "changelog_url": "%s", "date": "%s", "sha1": "%s" }' \
        "$KERNEL_NAME" "${KERNEL_TYPE^}" "$VERSION" "$LINK" "$CHANGELOG" "$DATE" "$SHA1")
    [[ -n $SUPPORT_LINK ]] && JSON+=$(printf ', "support": { "link": "%s" }' "$SUPPORT_LINK")

    prInfo "Creating compatible FKM updater JSON..."
    echo "{ $JSON }" | jq
}

# Kernel upload
kernUpload() {
    if [[ -z $RELEASE ]]; then
        # To Telegram
        prInfo "Uploading $ZIP to Telegram..."
        tgPost "*[BuildCI]* Uploading test build..." &
        if ! "$TELEGRAM" -f "$AK/$ZIP" -c "-1001494373196" \
            "New #$DEVICE test build ($KERNEL) with branch $BRANCH at commit $(git_pretty)."; then
            prWarn "Failed to upload $ZIP."
            tgPost "*[BuildCI]* Unable to upload the build." &
        fi
    else
        # or to webserver for release zip
        (
            # Unlikely to fail; but we have to define this way to satisfy shellcheck
            cd "$AK" || die "$BLD$(basename "$AK")$RST doesn't exist in defined path."

            prInfo "Uploading $RELEASE_ZIP..."
            if {
                rsync -qP --relative "$RELEASE_ZIP" krascgq@dl.kudnet.id:/var/www/dl.kudnet.id/kernels/"$DEVICE"/
                rsync -qP --relative "$RELEASE_ZIP" krascgq@storage.osdn.net:/storage/groups/k/ku/kudproject/kernels/"$DEVICE"/
            }; then
                prInfo "$RELEASE_ZIP uploaded successfully." \
                    "GitHub releases upload requires manual intervention, though."
                TELEGRAM_CHAT="-1001368407111 -1001181003922" \
                    tgPost "*New MoeSyndrome Kernel build is available!*" \
                    "*Name:* \`$RELEASE_ZIP\`" \
                    "*Build Date:* \`$(sed '4q;d' "$OUT"/include/generated/compile.h | cut -d ' ' -f 6-11 | sed -e s/\"//)\`" \
                    "*Downloads:* [Webserver](https://dl.kudnet.id/kernels/$DEVICE/$RELEASE_ZIP) | [OSDN](https://osdn.net/dl/kudproject/$RELEASE_ZIP)" &
            else
                prWarn "Failed to upload $RELEASE_ZIP."
            fi
        )
    fi
}
